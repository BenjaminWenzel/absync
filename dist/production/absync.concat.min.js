!function(){"use strict";angular.module("absync",[])}(),function(e){"use strict";function t(e,t){var r=this;r.__ioSocket=null,r.__registerLater=[],r.__collections={},r.configure=function(e){var t=e.socket||e;if("function"==typeof t)r.__ioSocket=t();else{if(!(io&&io.Socket&&t instanceof io.Socket))throw new Error("configure() expects input to be a function or a socket.io Socket instance.");r.__ioSocket=t}r.__registerLater.length&&(angular.forEach(r.__registerLater,function(e){this.__handleEntityEvent(e.eventName,e.callback,e.rootScope)}),r.__registerLater=[])},r.collection=function(e,i){if(r.__collections[e])throw new Error("A collection with the name '"+e+"' was already requested. Names for collections must be unique.");r.__collections[e]=n(e,i),t.factory(e,r.__collections[e])},r.$get=function(e){return new i(this,e)},r.$get.$inject=["$rootScope"]}function i(e,t){this.__absyncProvider=e,this.__rootScope=t}function n(e,t){function i(i,n,o,a,c,l){function s(e){o.info("Updating entity in cache...");for(var t=!1,i=0,n=u.entityCache[0],r=u.entityCache.length;r>i;++i,n=u.entityCache[i])if(n.id==e.id){c.$broadcast("beforeEntityUpdated",{service:u,cache:u.entityCache,entity:u.entityCache[i],updated:e});var a=u.entityCache[i];a.copyFrom?a.copyFrom(e):angular.extend(a,e),t=!0,c.$broadcast("entityUpdated",{service:u,cache:u.entityCache,entity:u.entityCache[i]});break}t||(u.entityCache.push(e),c.$broadcast("entityNew",{service:u,cache:u.entityCache,entity:e}))}function f(e){for(var t=0,i=u.entityCache[0],n=u.entityCache.length;n>t;++t,i=u.entityCache[t])if(i.id==e){c.$broadcast("beforeEntityRemoved",{service:u,cache:u.entityCache,entity:i}),u.entityCache.splice(t,1),c.$broadcast("entityRemoved",{service:u,cache:u.entityCache,entity:i});break}}var u=this;o.info("absync service for '"+t.collectionName+"' was instantiated.");var d=t.injector||n,y=d.has(t.model);if(!y)throw new Error("Unable to construct the '"+e+"' service, because the referenced model '"+t.model+"' is not available for injection.");var h=d.get(t.model),p=h.serialize||t.serialize||r,v=h.deserialize||t.deserialize||r;return u.name=t.collectionName,u.entityCache=[],u.entityCacheRaw=null,u.dataAvailableDeferred=u.dataAvailableDeferred||a.defer(),u.objectsAvailableDeferred=u.objectsAvailableDeferred||a.defer(),u.dataAvailable=u.dataAvailableDeferred.promise,u.objectsAvailable=u.objectsAvailableDeferred.promise,u.httpInterface=i,u.serializer=p,u.deserializer=v,u.ensureLoaded=function(e){if(e=e===!0,null===u.entityCacheRaw||e){if(u.entityCacheRaw=[],!t.collectionName||!t.collectionUri)return a(!0);o.info("Retrieving '"+t.collectionName+"' collectionâ€¦"),u.httpInterface.get(t.collectionUri).then(function(e){u.entityCacheRaw=e.data,u.dataAvailableDeferred.resolve(e.data)},function(e){u.entityCacheRaw=null,c.$emit("authorizationError",e)})}return a.all([u.dataAvailable,u.objectsAvailable])},u.dataAvailable.then(function(e){u.entityCache=u.entityCache||[],e[t.collectionName].forEach(function(e){u.entityCache.push(u.deserializer(e))}),u.objectsAvailableDeferred.resolve(u.entityCache),c.$broadcast("collectionNew",{service:u,cache:u.entityCache})}),u.read=function(e){function i(e){if(!e[t.entityName])return n.reject(new Error("The requested entity could not be found in the database.")),n.promise;var i=u.deserializer(e[t.entityName]);s(i),n.resolve(i)}for(var n=a.defer(),r=0,o=u.entityCache[0],c=u.entityCache.length;c>r;++r,o=u.entityCache[r])if(o.id==e)return n.resolve(o),n.promise;return u.httpInterface.get(t.entityUri+"/"+e).success(i),n.promise},u.update=function(e){var i,n=u.reduceComplex(e),r=u.serializer(n),a={};return a[t.entityName]=r,"undefined"!=typeof e.id?(i=u.httpInterface.put(t.entityUri+"/"+e.id,a),i.then(function(e){if(e.data[t.entityName]){var i=u.deserializer(e.data[t.entityName]);s(i)}},function(e){o.error(e)})):(i=u.httpInterface.post(t.collectionUri,a),i.then(function(e){if(e.data[t.entityName]){var i=u.deserializer(e.data[t.entityName]);s(i)}},function(e){o.error(e)})),i},u.create=u.update,u["delete"]=function(e){var i=a.defer(),n=e.id;return u.httpInterface["delete"](t.entityUri+"/"+n).success(function(e,t,r,o){f(n),i.resolve()}).error(function(e,t,n,r){o.error(e),i.reject(new Error("Unable to delete entity."))}),i.promise},u.lookupTableById=function(){for(var e=[],t=0,i=u.entityCache.length;i>t;++t)e[u.entityCache[t].id]=u.entityCache[t];return e},u.reduceComplex=function(e,t){var i=t?[]:{};for(var n in e)e.hasOwnProperty(n)&&(i[n]=Array.isArray(e[n])?u.reduceComplex(e[n],!0):e[n]&&e[n].id?e[n].id:e[n]);return i},u.populateComplex=function(e,t,i,n){if(Array.isArray(e[t])){var r=e[t].map(function(r,o){if("string"!=typeof e[t][o]){if(!n||"object"!=typeof e[t][o]||"string"!=typeof e[t][o].id)return a.when(!1);e[t][o]=e[t][o].id}return i.read(e[t][o]).then(function(i){e[t][o]=i})});return a.all(r)}if("string"!=typeof e[t]){if(!n||"object"!=typeof e[t]||"string"!=typeof e[t].id)return a.when(!1);e[t]=e[t].id}return i.read(e[t]).then(function(i){e[t]=i})},c.$on(t.entityName,function(e,t){var i=t;1==Object.keys(i).length&&i.hasOwnProperty("id")?(o.info("Entity was deleted from the server. Updating cache..."),f(i.id)):s(u.deserializer(i))}),c.$on(t.collectionName,function(e,t){for(var i=t;0<u.entityCache.length;)u.entityCache.pop();i.forEach(function(e){s(u.deserializer(e))})}),l.on(t.entityName,function(e){c.$broadcast(t.entityName,e[t.entityName])}),l.on(t.collectionName,function(e){c.$broadcast(t.collectionName,e[t.collectionName])}),u}return i.$inject=["$http","$injector","$log","$q","$rootScope","absync"],i}function r(e){return e}angular.module("absync").provider("absync",t),t.$inject=["$injector","$provide"],i.prototype.configure=function(e){var t=this.__absyncProvider;t.configure(e)},i.prototype.on=function(e,t){var i=this.__absyncProvider,n=this;return i.__ioSocket?void this.__handleEntityEvent(e,t,n.__rootScope):void i.__registerLater.push({eventName:e,callback:t,rootScope:i.__rootScope})},i.prototype.emit=function(e,t,i){var n=this.__absyncProvider;if(!n.ioSocket)throw new Error("socket.io is not initialized.");var r=this.rootScope;n.__ioSocket.emit(e,t,function(){var e=arguments;r.$apply(function(){i&&i.apply(n.ioSocket,e)})})},i.prototype.__handleEntityEvent=function(e,t,i){var n=this.__absyncProvider,r=function(){var e=arguments;i.$apply(function(){t.apply(n.__ioSocket,e)})};return n.__ioSocket.on(e,r),function(){n.__ioSocket.removeListener(e,r)}}}();
//# sourceMappingURL=maps/absync.concat.min.js.map